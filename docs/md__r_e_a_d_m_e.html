<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>TriggerApplication: TriggerApplication</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TriggerApplication
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">TriggerApplication </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Trigger Application is designed as a modular trigger software to run successive triggers on WCSim data.</p>
<p>It's built from ToolDAQ Application <a href="#myfootnote1">[1]</a> which is an open source general DAQ Application template built using the modular ToolDAQ Framework core <a href="#myfootnote2">[2]</a> to give separation between core and implementation code.</p>
<hr/>
<h1>Concept</h1>
<hr/>
<p>The main executable creates a <a class="el" href="class_tool_chain.html">ToolChain</a> which is an object that holds Tools. Tools are added to the <a class="el" href="class_tool_chain.html">ToolChain</a> and then the <a class="el" href="class_tool_chain.html">ToolChain</a> can be told to Initialise Execute and Finalise each tool in the chain.</p>
<p>The <a class="el" href="class_tool_chain.html">ToolChain</a> also holds a user-defined <a class="el" href="class_data_model.html">DataModel</a> which each tool has access too and can read, update and modify. This is the method by which data is passed between Tools.</p>
<p>User Tools can be generated for use in the tool chain by including a <a class="el" href="class_tool.html">Tool</a> header. This can be done manually or by use of the newTool.sh script.</p>
<p>For more information consult the ToolDAQ doc.pdf</p>
<p><a href="https://github.com/ToolDAQ/ToolDAQFramework/blob/master/ToolDAQ%20doc.pdf">https://github.com/ToolDAQ/ToolDAQFramework/blob/master/ToolDAQ%20doc.pdf</a></p>
<hr/>
<h1>Tutorial</h1>
<p>Note that there are <code>README.md</code> files in most folders. Check them out!</p>
<ul>
<li><a href="#key-concepts">Key concepts</a><ul>
<li><a href="#tool">Tool</a></li>
<li><a href="#toolchain">Toolchain</a></li>
<li><a href="#datamodel">DataModel</a></li>
</ul>
</li>
<li><a href="#installation">Installation</a><ul>
<li><a href="#docker">Docker</a></li>
<li><a href="#from-github-source">From GitHub source</a></li>
</ul>
</li>
<li><a href="#running">Running</a><ul>
<li><a href="#creating-your-own-trigger-chain">Creating your own trigger chain</a></li>
<li><a href="#creating-your-own-trigger">Creating your own trigger</a></li>
</ul>
</li>
</ul>
<h2>Key concepts</h2>
<h3><a class="el" href="class_tool.html">Tool</a></h3>
<p>A tool is a class that does something. They are found in the <code>UserTools</code> directory. Examples includes</p>
<ul>
<li><code><a class="el" href="class_w_c_sim_reader.html">WCSimReader</a></code> &ndash; Reads in WCSim files</li>
<li><code>nhits</code> &ndash; Runs an nhits trigger</li>
<li><code><a class="el" href="class_data_out.html">DataOut</a></code> &ndash; Writes out WCSim-format files with only triggered digits</li>
</ul>
<p>Each tool implements 3 methods</p>
<ul>
<li><code>Initialise()</code> &ndash; Is run once at the start. Read configuration, setup trees, etc. here.</li>
<li><code>Execute()</code> &ndash; Is run once per event. Do the main work of the tool here.</li>
<li><code>Finalise()</code> &ndash; Is run once at the end. Close &amp; write files, <code>delete</code> memory, etc. here</li>
</ul>
<h3>Toolchain</h3>
<p>A toolchain is a collection of tools, along with configuration files. They are found in the <code>configfiles</code> directory. For example</p>
<ul>
<li><code><a class="el" href="class_w_c_sim_reader.html">WCSimReader</a></code> - <code>nhits</code> - <code><a class="el" href="class_data_out.html">DataOut</a></code> &ndash; Reads a WCSim file, triggers on it, and writes out a new WCSim-formatted file</li>
</ul>
<p>Note that you can use the same tool multiple times, with different (or the same) configuration</p>
<p>Note that tools are run consecutively. i.e. if you have two tools (t1, t2) the following order will be used:</p>
<ul>
<li><code>t1::Initialise()</code> - <code>t2::Initalise()</code> - <code>t1::Execute()</code> - <code>t2::Execute()</code> - <code>t1::Execute()</code> - <code>t2::Execute()</code> - ... - <code>t1::Finalise()</code> - <code>t2::Finalise()</code></li>
</ul>
<h3><a class="el" href="class_data_model.html">DataModel</a></h3>
<p>Tools cannot communicate directly with one another. They rely on passing data between each other using a transient data model. This is found in the <code><a class="el" href="class_data_model.html">DataModel</a></code> folder</p>
<h2>Installation</h2>
<h3>Docker</h3>
<p>Docker is a platform independent container system which eases the headache of long installation and incompatibility problems. By creating a container form the image you will have a native Centos 7 terminal with all the prerequisites installed and the software guaranteed to work.</p>
<p>1) Install docker check either your platforms package manager or <a href="https://www.docker.com">https://www.docker.com</a> for the software 2) Get the latest container image <code>docker pull hkdaq/triggerapplication:latest</code> 3) Run an instance of the container which will have the trigger application and all dependencies installed <code>docker run --name=TriggerApplication -it hkdaq/triggerapplication:latest</code> Note: only run once or you will make multiple contianers</p>
<p>Once the container has started to run the software 1) <code>./main</code></p>
<ul>
<li>This runs an example toolchain with two versions of the <code>dummy</code> tool. It's essentially a Hello World tool</li>
</ul>
<p>You're then free to install any applications in your container you wish for development</p>
<ul>
<li>If you are using optional packages (e.g. <a href="https://github.com/hyperk/hk-BONSAI">hk-BONSAI</a> or <a href="https://github.com/HKDAQ/FLOWER">FLOWER</a>) install them in <code>$HYPERKDIR</code> and they will automatically be found whenever you start your container (and <code><a class="el" href="_build_8h.html">Build.h</a></code> and <code>$LD_LIBRARY_PATH</code> will be set appropriately).<ul>
<li>If you do install such packages, remember to <code>source Setup.sh</code> (or exit the container and come back in if you've installed them in <code>$HYPERKDIR</code>), and <code>make clean; make</code> again, in order to build the tools that depend on the optional packages (e.g. the <a class="el" href="class_b_o_n_s_a_i.html">BONSAI</a> tool for the hk-BONSAI package)</li>
</ul>
</li>
</ul>
<p>Notes:</p>
<ul>
<li>To exit a container use <code>exit</code></li>
<li>To restart a container use <code>docker start -i TriggerApplicaiton</code></li>
<li>To see current containers use <code>docker ps -a</code></li>
<li>To delete a container use <code>docker rm TriggerApplciaiton</code></li>
<li>When creating a container you can mount a folder from your native os with the <code>-v</code> run option e.g. <code>docker run --name=TriggerApplication -v local_folder_path:container_mount_path -it hkdaq/triggerapplication:latest</code></li>
</ul>
<h3>From GitHub source</h3>
<ul>
<li>Clone from <a href="https://github.com/HKDAQ/TriggerApplication">https://github.com/HKDAQ/TriggerApplication</a><ul>
<li>Note the model used to commit to the main version of TriggerApplication is fork and pull request. So do fork if you need to!</li>
</ul>
</li>
<li>Make sure you have sourced WCSim i.e. that you have <code>$WCSIMDIR</code> set<ul>
<li>Note that this will work with the current WCSim develop branch.<ul>
<li>Versions of WCSim older than v1.8.0 will almost certainly not work. (<code>kTriggerNoTrig</code> added in v1.8.0; <code>WCSimRootOptions</code> added in v1.7.0)</li>
</ul>
</li>
<li>Note that you also need ROOT setup (a WCSim prerequisite)</li>
</ul>
</li>
<li>(Optional) If you want to run the <a class="el" href="class_b_o_n_s_a_i.html">BONSAI</a> tool, make sure you have sourced <a href="https://github.com/hyperk/hk-BONSAI">hk-BONSAI</a> i.e. that you have <code>$BONSAIDIR</code> set</li>
<li>(Optional) If you want to run the FLOWER tool, make sure you have sourced <a href="https://github.com/HKDAQ/FLOWER">FLOWER</a> i.e. that you have <code>$FLOWERDIR</code> set</li>
<li>(Optional) for compiling over GPU, set the CUDADIR variable, for example export CUDADIR="/usr/local/cuda"</li>
<li>Run <code>./GetToolDAQ.sh</code><ul>
<li>This gets and compiles the prerequisites: ToolDAQ, boost, and zmq</li>
<li>You can optionally install Root</li>
<li><code>./GetToolDAQ.sh --help</code> for the flags to turn on/off each of the prerequisites</li>
</ul>
</li>
</ul>
<p>To check it has built successfully:</p>
<ul>
<li><code>source Setup.sh</code></li>
<li>Check it runs with <code>./main</code><ul>
<li>This runs an example toolchain with two versions of the <code>dummy</code> tool. It's essentially a Hello World tool</li>
</ul>
</li>
</ul>
<h4>Installing an optional package later</h4>
<p>If you do install optional packages after the initial compliation of TriggerApplication, once they are setup correctly (see above) it is a two-step process to build the tools that depend on the optional packages</p>
<ul>
<li><code>source Setup.sh</code></li>
<li><code>make clean; make</code></li>
</ul>
<h4>GPU code</h4>
<p>Some triggers have been developed to be run on CUDA-compatible GPUs. If you want to use these (and you have a compatible system)</p>
<ul>
<li><code>source Setup.sh</code></li>
<li><code>make GPU</code></li>
<li><code>./mainGPU</code></li>
</ul>
<h2>Running</h2>
<ol type="1">
<li>Choose the toolchain you want to run<ul>
<li>We use <code>WCSimReaderTest</code> as an example</li>
<li>See <a href="https://github.com/WCSim/WCSim">https://github.com/WCSim/WCSim</a> for how to compile and run WCSim<ul>
<li>Running <code>cd $WCSIMDIR; ./bin/Linux-g++/WCSim WCSim.mac</code> will create the expected output file for this tutorial.</li>
</ul>
</li>
</ul>
</li>
<li>Check the configuration files are doing what you want them to in <code>configfiles/WCSimReaderTest</code><ul>
<li><code>ToolChainConfig</code> &ndash; Sets up how many events to run on, what to do on errors, etc. You probably don't need to alter this</li>
<li><code>ToolsConfig</code> &ndash; Select which tool(s) you want to use, and the configuration file of each version of the tool</li>
<li><code>WCSimReaderToolConfig</code> &ndash; Options for the <code><a class="el" href="class_w_c_sim_reader.html">WCSimReader</a></code> tool. Select the input file(s), number of events to loop over, and tool verbosity<ul>
<li>Note the default WCSim input file is <code>$WCSIMDIR/wcsim.root</code></li>
</ul>
</li>
<li><code>nhitsToolConfig</code> &ndash; Select the trigger options (e.g. threshold), whether to apply it to ID or OD digits, and tool verbosity</li>
<li><code>DataOutToolConfig</code> &ndash; Select the output filename, whether to save multiple digits per PMT per trigger, the digit time offset, and tool verbosity.<ul>
<li>Note the default output file is <code>triggered.root</code></li>
</ul>
</li>
</ul>
</li>
<li>Run as <code>./main WCSimReaderTest</code></li>
</ol>
<h2>Creating your own trigger chain</h2>
<ol type="1">
<li><code>cd $ToolDAQapp/configfiles</code></li>
<li><code>./Create_run_config.sh TOOLCHAINNAME</code></li>
<li>Write you configuration files in <code>$ToolDAQapp/configfiles/TOOLCHAINNAME</code></li>
<li><code>cd $ToolDAQapp</code><ul>
<li>Note you can setup your configuration files with absolute paths such that you don't need to <code>cd</code></li>
</ul>
</li>
<li>Run with <code>./main TOOLCHAINNAME</code></li>
</ol>
<h2>Creating your own trigger</h2>
<ol type="1">
<li><code>cd $ToolDAQapp/UserTools</code></li>
<li><code>./newTool.sh TOOLNAME</code><ul>
<li>Note the convention for triggers is to start TOOLNAME with a lower case. For other tools, start with an upper case</li>
</ul>
</li>
<li>Write your trigger in the new class that has been created (<code>$ToolDAQapp/UserTools/TOOLNAME/TOOLNAME.{cpp,h}</code>files<ul>
<li>Implement <code>Initalise()</code><ul>
<li><code>m_variables.Get("verbose", verbose);</code> is an example of reading in configuration options</li>
</ul>
</li>
<li>Implement <code>Execute()</code><ul>
<li>Triggers shouldn't read truth information (although you could implement truth cherry pickers...) so you should only use the following from the <a class="el" href="class_data_model.html">DataModel</a> <code>m_data</code><ul>
<li><b>Inputs</b><ul>
<li><code>IDSamples</code> and <code>ODSamples</code> contain all the digit information i.e. charge, time, tubeID</li>
<li><code>IDGeom</code> and <code>ODGeom</code> contain all the PMT information i.e tubeID, x, y, z<ul>
<li>Note that this can be expanded to include e.g. PMT rotation</li>
</ul>
</li>
</ul>
</li>
<li><b>Outputs</b><ul>
<li>Use <code><a class="el" href="class_trigger_info.html#a29808bd2956d4561fa6e5f77bb23ab60" title="Add a trigger, all times in ns. ">TriggerInfo::AddTrigger()</a></code> to save triggers in <code>IDTriggers</code> or <code>ODTriggers</code></li>
</ul>
</li>
</ul>
</li>
<li>You can implement both CPU and CUDA-based GPU versions of your code<ul>
<li>It is recommended to always have a CPU version of the code, since this allows anyone to use it; access to GPUs is not ubiquitous</li>
<li>Use the following to select the correct version of the code, and hide GPU code from systems that cannot compile it ``` #ifdef GPU // GPU code #else // CPU CODE #endif //GPU ```</li>
</ul>
</li>
</ul>
</li>
<li>Implement <code>Finalise()</code><ul>
<li>Remember to <code>delete</code> any memory you've allocated</li>
</ul>
</li>
<li>Check other triggers for more information<ul>
<li><code><a class="el" href="classpass__all.html">pass_all</a></code> is a very simple example</li>
<li><code>nhits</code> is a relatively simple example. It has CPU and GPU versions</li>
</ul>
</li>
</ul>
</li>
<li>Use <code>make</code> and/or <code>makeGPU</code> to build it (you will need to create an environment variable CUDADIR pointing to your system CUDA installation, for example export CUDADIR="/usr/local/cuda" or export CUDADIR="/usr/local/cuda-8.0")</li>
<li>Add your tool to a toolchain to test it with <code>./main TOOLCHAINNAME</code><ul>
<li>Or <code>./mainGPU TOOLCHAINNAME</code> for GPU code</li>
</ul>
</li>
<li>Write the README: <code>$ToolDAQapp/UserTools/TOOLNAME/README.md</code></li>
</ol>
<hr/>
<p>Copyright (c) 2018 Hyper-k Collaboration</p>
<p><a class="anchor" id="myfootnote1"></a>[1] Benjamin Richards. (2018, November 11). ToolDAQ Application v2.1.2 (Version V2.1.2). Zenodo. <a href="http://doi.org/10.5281/zenodo.1482772">http://doi.org/10.5281/zenodo.1482772</a></p>
<p><a class="anchor" id="myfootnote2"></a>[2] Benjamin Richards. (2018, November 11). ToolDAQ Framework v2.1.1 (Version V2.1.1). Zenodo. <a href="http://doi.org/10.5281/zenodo.1482767">http://doi.org/10.5281/zenodo.1482767</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Jul 2 2020 17:27:57 for TriggerApplication by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
